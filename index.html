<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Ollu-cybersaints-lab-documentation by Ashkore</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Ollu-cybersaints-lab-documentation</h1>
      <h2 class="project-tagline"></h2>
      <a href="https://github.com/Ashkore/OLLU-AITP-Lab-Documentation" class="btn">View on GitHub</a>
      <a href="https://github.com/Ashkore/OLLU-AITP-Lab-Documentation/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/Ashkore/OLLU-AITP-Lab-Documentation/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="lab-hardware--layout" class="anchor" href="#lab-hardware--layout" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Lab Hardware / Layout</h1>

<p>2 Unmanaged trednet gigabit switches<br>
2 Poweredge T300 Server</p>

<pre><code>1 Intel Core 2 Duo E6305 @ 1.86GHz
24GB Ram
4 250GB HDD's &gt; Raid 0
</code></pre>

<p>1 Poweredge T605 Server</p>

<pre><code>2 Quad-Core AMD Opteron 2350
32GB Ram
4 250GB HDD's &gt; Raid 0
</code></pre>

<h5>
<a id="lab-hardware--layout-image" class="anchor" href="#lab-hardware--layout-image" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Lab Hardware / Layout Image</h5>

<h1>
<a id="lab-software--layout" class="anchor" href="#lab-software--layout" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Lab Software / Layout</h1>

<p>Each Poweredge server is running ESX 6.0<br>
A virtual Vcenter Server Appliance is running on the T605<br>
A virtual Debian DHCP/Apache2 server is running DNSMASQ<br>
The rest of the VM's are VM's from <a href="http://www.Vulnhub.com">www.Vulnhub.com</a>  </p>

<hr>

<h1>
<a id="configuration-detials" class="anchor" href="#configuration-detials" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration detials</h1>

<p>Each ESX host has 3 scripts running on it:<br>
    Revert_Snapshots.sh, Create_Snapshots.sh, Script.sh<br>
    All 3 are stored in the /root directory of the ESX host.<br>
The DHCP/Apache2 server has 2 scripts on it:<br>
    IP_TO_MAC.sh and Order.sh<br>
    Both are stored in the /root directory of the VM.  </p>

<hr>

<h1>
<a id="scripts" class="anchor" href="#scripts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Scripts</h1>

<h2>
<a id="esx" class="anchor" href="#esx" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>ESX</h2>

<p>Revert_Snapshots.sh</p>

<pre><code>#Get all vmid's where not the vcenter or the DHCP server
VMIDS=$(vim-cmd vmsvc/getallvms | grep -v 01_Vcenter | grep -v 02_DNS_DHCP | awk '{print $1 }' | grep -v Vmid)
#loop though VMID's and check if there is a snapshot by the name of fresh install. If so, revert the vm to that snapshot and then power on the VM
for VMID in $VMIDS
do
        case $VMID in
                ''|*[!0-9]*);;
                *)
                vim-cmd vmsvc/get.snapshot $VMID | grep "Fresh Install"
                if [ $? -eq 0 ]; then
                        echo $(vim-cmd vmsvc/get.summary $VMID | grep name)
                        SnapShotID=$(vim-cmd vmsvc/snapshot.get $VMID | grep "Fresh Install" -A 1 | grep "Id" | awk '{print $4}')
                        vim-cmd vmsvc/snapshot.revert $VMID $SnapShotID 0
                        vim-cmd vmsvc/power.on $VMID
                fi
                ;;
        esac
done
</code></pre>

<p>Create_Snapshots.sh</p>

<pre><code>#Get all vmid's where not the vcenter or the DHCP server
VMIDS=$(vim-cmd vmsvc/getallvms | grep -v 01_Vcenter | grep -v 02_DNS_DHCP | awk '{print $1 }' | grep -v Vmid)
#loop though VMID's and check if there is a snapshot by the name of fresh install. If not, take a snapshot called fresh install.
for VMID in $VMIDS
do
        case $VMID in
                ''|*[!0-9]*);;
                *)
                vim-cmd vmsvc/get.snapshot $VMID | grep "Fresh Install" &gt; /dev/null
                if [ ! $? -eq 0 ]; then
                        vim-cmd vmsvc/snapshot.create $VMID "Fresh Install"
                fi
                ;;
        esac
done
</code></pre>

<p>Script.sh</p>

<pre><code>#Get all vmid's
VMIDS=$(vim-cmd vmsvc/getallvms | awk '{print $1 }' | grep -v Vmid)
echo "" &gt; MAC_ADDRESSES
#loop though VMID's and get the mac address and name of the vm. Add them to a file.
for VMID in $VMIDS
do
        case $VMID in
                ''|*[!0-9]*);;
                *)
                MacAddress=$(vim-cmd vmsvc/device.getdevices $VMID | grep macAddress | sed 's/macAddress = "//' | sed 's/",//' | sed -r 's/\s+//g')
                VmName=$(vim-cmd vmsvc/get.summary $VMID | grep name | sed 's/name = "//' | sed 's/",//' | sed -r 's/\s+//g')
                echo $MacAddress        $VmName &gt;&gt; MAC_ADDRESSES
                ;;
        esac
done
</code></pre>

<p>crontab (/var/spool/cron/crontabs/root)</p>

<pre><code>#Run every 5 minutes
*/5 * * * * /root/script.sh
#Run every Saturday at 5am
* 5 * * 6/root/Create_Snapshots.sh
#Run every Sunday at 5am
* 5 * * 7/root/Revert_Snapshots.sh
</code></pre>

<p>After configuring crontab you should run the following commands to restart crontab</p>

<pre><code>kill $(cat /var/run/crond.pid)
/usr/lib/vmware/busybox/bin/busybox crond
</code></pre>

<h2>
<a id="dhcpapache2" class="anchor" href="#dhcpapache2" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>DHCP/Apache2</h2>

<p>IP_TO_MAC.sh</p>

<pre><code>#This script creates the HTML page to show the IP addresses and VMnames
#make sure file is empty
echo "" &gt; /root/iptomac
#add the title html to file
echo "&lt;title&gt;CyberSaints Vurnable IP's&lt;/title&gt;" &gt;&gt; /root/iptomac
#add the text to file
echo "&lt;i&gt;This webpage is updated every minute. If there are any issues, check the /root/order.log file. The scripts that create this page are in /root&lt;/i&gt;&lt;br&gt;&lt;br&gt;" &gt;&gt; /root/iptomac
echo "If you are trying to pentest one of these IP's and are struggling, try a walkthough at www.vulnhub.com" &gt;&gt; /root/iptomac
#Add table start to file
echo "&lt;table&gt;" &gt;&gt; /root/iptomac
#Add table headers to file
echo "&lt;tr&gt;&lt;th&gt;VMname&lt;/th&gt;&lt;th&gt;Ipaddress&lt;/th&gt;&lt;/tr&gt;" &gt;&gt; /root/iptomac
#loop through the DHCP file, compare the macs to the files in MAC. If they match, add a new row to the html file of IP/VMname
while read line; do
    MAC=$(echo $line | awk '{print $1}')
    if grep -Rq $MAC /root/MAC
    then
        echo "&lt;tr&gt;&lt;td&gt;" &gt;&gt; /root/iptomac
        echo $(grep -R $MAC /root/MAC | awk '{print $2}' &gt;&gt; /root/iptomac
        echo "&lt;/td&gt;&lt;td&gt;" &gt;&gt; /root/iptomac
        echo $line | awk '{print $2}') &gt;&gt; /root/iptomac
        echo "&lt;/td&gt;&lt;/tr&gt;" &gt;&gt; /root/iptomac
    fi
done &lt;/root/DHCP
echo "&lt;/table&gt;" &gt;&gt;/root/iptomac
#Copy the file to the index.html file to be displayed to website
cp /root/iptomac /var/www/html/index.html
</code></pre>

<p>Order.sh</p>

<pre><code>#Gets all of the IP's and Mac addresses that have been leased
cat /var/lib/misc/dnsmasq.leases | awk '{print $2 " " $3}' &gt; /root/DHCP
#obtains the Mac addresses from ESX4
scp root@192.168.1.10:/MAC_ADDRESSES /root/MAC_ESX4
#obtains the Mac addresses from ESX3
scp root@192.168.1.9:/MAC_ADDRESSES /root/MAC_ESX3
#obtains the Mac addresses from ESX2
scp root@192.168.1.8:/MAC_ADDRESSES /root/MAC_ESX2
#Combines all of the individual Mac Address files into one
cat /root/MAC_ESX* &gt; /root/MAC
#Runs the IP_TO_MAC script
/root/IP_TO_MAC.sh
</code></pre>

<p>crontab</p>

<pre><code>#Runs every minute
*/1 * * * * /root/order.sh &gt;&gt; /root/order.log
</code></pre>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/Ashkore/OLLU-AITP-Lab-Documentation">Ollu-cybersaints-lab-documentation</a> is maintained by <a href="https://github.com/Ashkore">Ashkore</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
